---
title: "A test ting"
output: html_notebook
---


```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(gridExtra)
library(GGally) #for ggpairs
library(psych)
library(ggiraph)
library(ggiraphExtra)
```

```{r}
# IMPORTANT must import the data and apply these manipulations first. Otherwise the function will not work

covid_set <- read.csv('data/covid_data/covid_19_clean_complete.csv')
covid_set <- covid_set %>% mutate(date_str =  as.Date(as.POSIXct(Date, format="%m/%d/%y"))) %>% arrange(date_str)
covid_set

```

```{r}
# plotting deaths function
# USAGE: plot_deaths('Canada')
plot_deaths <- function(country) {
  country_set <- covid_set %>% filter(Country.Region == country)
  country_set.agg <- aggregate(select(country_set, Confirmed, Deaths, Recovered), by=country_set['date_str'], sum)
  deaths <- ggplot(country_set.agg, mapping = aes(date_str, Deaths)) + geom_line() + labs(title=paste('Deaths', country), x='Date', y='Deaths')
  return(deaths)
}

# plotting confirmed function
# USAGE: plot_confirmed('Canada')
plot_confirmed <- function(country) {
  country_set <- covid_set %>% filter(Country.Region == country)
  country_set.agg <- aggregate(select(country_set, Confirmed, Deaths, Recovered), by=country_set['date_str'], sum)
  confirmed <- ggplot(country_set.agg, mapping = aes(date_str, Confirmed)) + geom_line() + labs(title=paste('Confirmed Cases ', country), x='Date', y='Cases')
  return(confirmed)
}

# plotting recovered function
# USAGE: plot_confirmed('Canada')
plot_recovered <- function(country) {
  country_set <- covid_set %>% filter(Country.Region == country)
  country_set.agg <- aggregate(select(country_set, Confirmed, Deaths, Recovered), by=country_set['date_str'], sum)
  recovered <- ggplot(country_set.agg, mapping = aes(date_str, Recovered)) + geom_line() + labs(title=paste('Recovered ', country), x='Date', y='Recovered')
  return(recovered)
}


plot_deaths('Canada')
plot_confirmed('Canada')
plot_recovered('Canada')
```

```{r}
# plotting change in deaths
# USAGE plot_change_deaths('Canada')
plot_change_deaths <- function(country) {
  country_set <- covid_set %>% filter(Country.Region == country)
  country_set.agg <- aggregate(select(country_set, Confirmed, Deaths, Recovered), by=country_set['date_str'], sum)
  country_set.new_by_week <- country_set.agg %>% mutate(new_deaths_by_week=Deaths - lag(Deaths, 7))
  plot <- ggplot(country_set.new_by_week, mapping = aes(Deaths, new_deaths_by_week)) + geom_line() + labs(title=paste('Trajectory of Deaths', country), y='New Deaths (past week)', x='Total Deaths')
  return(plot)
}

# plotting change in cases
# USAGE plot_change_confirmed('Canada')
plot_change_confirmed <- function(country) {
  country_set <- covid_set %>% filter(Country.Region == country)
  country_set.agg <- aggregate(select(country_set, Confirmed, Deaths, Recovered), by=country_set['date_str'], sum)
  country_set.new_by_week <- country_set.agg %>% mutate(new_confirmed_by_week=Confirmed - lag(Confirmed, 7))
  plot <- ggplot(country_set.new_by_week, mapping = aes(Confirmed, new_confirmed_by_week)) + geom_line() + labs(title=paste('Trajectory of Confirmed Cases', country), y='New Confirmed Cases (past week)', x='Total Confirmed Cases')
  return(plot)
}

plot_change_deaths('Canada')
plot_change_confirmed('Canada')
```




# Are we Flattening the Curve?

Governments all over the world have enacted social distancing measures in attempts to "flatten the curve". In more mathematical terms, flattening the curve means slowing the growth rate of the virus such that it is no longer on an exponential trajectory. This prevents the health care system from being overwhelmed and increase everyone's chances of surviving the virus. When we plot the confirmed cases over time it's difficult to visually tell if the growth is still exponential or if social distancing has slowed the growth.

```{r echo=FALSE}
require(gridExtra)

p1 <- plot_confirmed('South Korea') + theme(plot.title = element_text(size = 10))
p2 <- plot_change_confirmed('South Korea') + theme(plot.title = element_text(size = 10))

y <- c(0,2,4,8,16,32,64,128,256)
x <- c(0,2,6,14,30,62,126,254,510)
p3 <- ggplot(data.frame(x,y), aes(x, y)) + geom_line() + geom_point() + labs(title='y=2^x', x='Total Confirmed Cases', y='New Cases (past week)') + theme(plot.title = element_text(size = 10))

grid.arrange(p1, p2, p3, ncol=3)
```


A trajectory graph better illustrates the state of flattening the curve. The y axis represents the new confirmed cases in the past week, and the x axis represents the total confirmed cases. If the growth rate is exponential we can expect the graph to have a positive linear pattern. This can be demonstrated by graphing the function y=2^x. Once the growth has slowed and is no longer exponential, there a sharp dip in the graph.

A country that has done really well in containing the virus is South Korea. As demonstrated by the linear growth, South Korea started with an exponential growth like every other country, but their effective social distancing and rapid testing measures is reflected in the graph's sharp dip.

Using this graph provides a clear visual indication if a country has beaten the exponential growth and is on the right track towards flattening the curve.


